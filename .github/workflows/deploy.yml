name: ðŸš€ Ansible EC2 Generator CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy EC2 instance'
        required: false
        default: false
        type: boolean
      cleanup:
        description: 'Cleanup AWS resources'
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_HOST_KEY_CHECKING: False
  ANSIBLE_DEPRECATION_WARNINGS: False

jobs:
  validate:
    name: ðŸ” Validate & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ansible ansible-lint yamllint
        
    - name: ðŸ” Ansible version
      run: ansible --version
      
    - name: ðŸ§ª Syntax check - Main playbook
      run: ansible-playbook --syntax-check ec2-playbook.yml
      
    - name: ðŸ§ª Syntax check - Cleanup playbook
      run: ansible-playbook --syntax-check cleanup-playbook.yml
      
    - name: ðŸ“ YAML Lint
      run: |
        yamllint ec2-playbook.yml
        yamllint cleanup-playbook.yml
        yamllint vars/vars_sample.yml
      continue-on-error: true
      
    - name: ðŸ” Ansible Lint
      run: |
        ansible-lint ec2-playbook.yml
        ansible-lint cleanup-playbook.yml
      continue-on-error: true

  build:
    name: ðŸ—ï¸ Build Configuration
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Prepare configuration
      run: |
        echo "ðŸ“ Creating vars directory..."
        mkdir -p vars
        echo "ðŸ“„ Copying sample configuration..."
        cp vars/vars_sample.yml vars/vars.yml
        echo "âœ… Configuration prepared"
        
    - name: ðŸ“¦ Upload configuration artifact
      uses: actions/upload-artifact@v4
      with:
        name: vars-config
        path: vars/vars.yml
        retention-days: 1

  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: github.event.inputs.deploy == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    environment: 
      name: production
      url: https://console.aws.amazon.com/ec2
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ Install Ansible and AWS CLI
      run: |
        python -m pip install --upgrade pip
        pip install ansible boto3 botocore
        
        # Install AWS CLI
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        
    - name: ðŸ“¥ Download configuration artifact
      uses: actions/download-artifact@v4
      with:
        name: vars-config
        path: vars/
        
    - name: âš™ï¸ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        
    - name: ðŸ§ª Test AWS connection
      run: |
        aws sts get-caller-identity
        aws ec2 describe-regions --region ${{ secrets.AWS_REGION || 'us-east-1' }} --max-items 1
        
    - name: ðŸš€ Deploy EC2 instance
      run: |
        echo "ðŸš€ Starting EC2 deployment..."
        ansible-playbook ec2-playbook.yml -v
        echo "âœ… Deployment completed!"
        
    - name: ðŸ“Š Display deployment summary
      run: |
        echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… EC2 instance deployed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”‘ SSH key pair generated dynamically" >> $GITHUB_STEP_SUMMARY  
        echo "- ðŸ·ï¸ Resources tagged for easy identification" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’° Cost estimation provided in deployment logs" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§¹ Use cleanup workflow to terminate resources when done" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: ðŸ§¹ Cleanup AWS Resources
    runs-on: ubuntu-latest
    if: github.event.inputs.cleanup == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.cleanup == 'true')
    environment: 
      name: cleanup
      url: https://console.aws.amazon.com/ec2
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ Install Ansible and AWS CLI
      run: |
        python -m pip install --upgrade pip
        pip install ansible boto3 botocore
        
        # Install AWS CLI
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        
    - name: ðŸ”§ Prepare configuration
      run: |
        mkdir -p vars
        cp vars/vars_sample.yml vars/vars.yml
        
    - name: âš™ï¸ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        
    - name: ðŸ§¹ Cleanup AWS resources
      run: |
        echo "ðŸ§¹ Starting resource cleanup..."
        ansible-playbook cleanup-playbook.yml -e "confirm_termination=true" -v
        echo "âœ… Cleanup completed!"
        
    - name: ðŸ“Š Display cleanup summary
      run: |
        echo "## ðŸ§¹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AWS resources cleanup completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”‘ SSH key pairs removed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’° Ongoing costs should be stopped" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Verify in AWS Console that all resources were cleaned up" >> $GITHUB_STEP_SUMMARY
