---
# ============================================================================
# Ansible EC2 Instance Generator Playbook
# ============================================================================
# Purpose: Automated creation of EC2 instances with proper tagging and configuration
# Author: Infrastructure Automation Team
# Version: 2.0
# Last Updated: $(date +%Y-%m-%d)
# ============================================================================

- name: "Deploy EC2 Instance with Modern Ansible Modules"
  hosts: localhost
  connection: local
  gather_facts: true
  
  # Load configuration variables from external file
  vars_files:
    - vars/vars.yml
  
  # Pre-flight validation variables
  vars:
    required_vars:
      - aws_region
      - aws_instance_type
      - app_name
      - environment

  tasks:
    # ========================================================================
    # VALIDATION PHASE: Ensure all required variables are defined
    # ========================================================================
    - name: "Validate required variables are defined"
      fail:
        msg: "Required variable {{ item }} is not defined or empty"
      when: vars[item] is not defined or vars[item] == ""
      loop: "{{ required_vars }}"
      tags: [validation, always]

    - name: "Display deployment configuration"
      debug:
        msg:
          - "=== EC2 Deployment Configuration ==="
          - "Region: {{ aws_region }}"
          - "Instance Type: {{ aws_instance_type }}"
          - "Environment: {{ environment }}"
          - "Application: {{ app_name }}"
          - "Security Group: {{ aws_security_group | default('Will discover default') }}"
          - "Subnet: {{ vpc_subnet_id | default('Will discover default') }}"
      tags: [info, always]

    # ========================================================================
    # SSH KEY PAIR CREATION PHASE: Generate new key pair for this deployment
    # ========================================================================
    - name: "Generate unique key pair name"
      set_fact:
        dynamic_key_name: "{{ app_name }}-{{ environment }}-{{ ansible_date_time.epoch }}"
      tags: [keypair, security]

    - name: "Create new EC2 key pair"
      amazon.aws.ec2_key:
        name: "{{ dynamic_key_name }}"
        region: "{{ aws_region }}"
        state: present
      register: ec2_key_result
      tags: [keypair, security]

    - name: "Save private key to temporary file"
      copy:
        content: "{{ ec2_key_result.key.private_key }}"
        dest: "./{{ dynamic_key_name }}.pem"
        mode: '0600'
      when: ec2_key_result.key.private_key is defined
      tags: [keypair, security]

    - name: "Display key pair information"
      debug:
        msg:
          - "=== SSH Key Pair Created ==="
          - "Key Name: {{ dynamic_key_name }}"
          - "Key Fingerprint: {{ ec2_key_result.key.fingerprint | default('N/A') }}"
          - "Private Key Saved: ./{{ dynamic_key_name }}.pem"
          - "Note: Keep this private key secure and delete after use"
      tags: [keypair, info]

    # ========================================================================
    # VPC DISCOVERY PHASE: Find default VPC if not specified
    # ========================================================================
    - name: "Discover default VPC using AWS CLI"
      command: aws ec2 describe-vpcs --region {{ aws_region }} --filters Name=is-default,Values=true --query 'Vpcs[0].VpcId' --output text
      register: default_vpc_result
      when: vpc_subnet_id is not defined or vpc_subnet_id == ""
      tags: [vpc, discovery]

    - name: "Set discovered VPC ID"
      set_fact:
        discovered_vpc_id: "{{ default_vpc_result.stdout }}"
      when: 
        - vpc_subnet_id is not defined or vpc_subnet_id == ""
        - default_vpc_result.stdout != "None"
      tags: [vpc, discovery]

    - name: "Discover default subnet using AWS CLI"
      command: aws ec2 describe-subnets --region {{ aws_region }} --filters Name=vpc-id,Values={{ discovered_vpc_id }} Name=default-for-az,Values=true --query 'Subnets[0].SubnetId' --output text
      register: default_subnet_result
      when: 
        - vpc_subnet_id is not defined or vpc_subnet_id == ""
        - discovered_vpc_id is defined
      tags: [vpc, discovery]

    - name: "Set discovered subnet ID"
      set_fact:
        discovered_subnet_id: "{{ default_subnet_result.stdout }}"
      when:
        - vpc_subnet_id is not defined or vpc_subnet_id == ""
        - default_subnet_result.stdout is defined
        - default_subnet_result.stdout != "None"
      tags: [vpc, discovery]

    - name: "Set final subnet ID (custom or discovered)"
      set_fact:
        final_subnet_id: "{{ vpc_subnet_id if (vpc_subnet_id is defined and vpc_subnet_id != '') else discovered_subnet_id }}"
      tags: [vpc, discovery]

    - name: "Discover default security group using AWS CLI"
      command: aws ec2 describe-security-groups --region {{ aws_region }} --filters Name=group-name,Values=default Name=vpc-id,Values={{ discovered_vpc_id }} --query 'SecurityGroups[0].GroupId' --output text
      register: default_sg_result
      when: 
        - aws_security_group is not defined or aws_security_group == ""
        - discovered_vpc_id is defined
      tags: [security, discovery]

    - name: "Set final security group (custom or default)"
      set_fact:
        final_security_group: "{{ aws_security_group if (aws_security_group is defined and aws_security_group != '') else default_sg_result.stdout }}"
      when: aws_security_group is not defined or aws_security_group == ""
      tags: [security, discovery]

    - name: "Set final security group to custom value"
      set_fact:
        final_security_group: "{{ aws_security_group }}"
      when: aws_security_group is defined and aws_security_group != ""
      tags: [security, discovery]

    - name: "Display VPC and network configuration"
      debug:
        msg:
          - "=== Network Configuration ==="
          - "VPC ID: {{ discovered_vpc_id | default('Using custom VPC') }}"
          - "Subnet ID: {{ final_subnet_id }}"
          - "Security Group: {{ final_security_group }}"
          - "Configuration: {{ 'Using default VPC/subnet' if discovered_vpc_id is defined else 'Using custom network settings' }}"
      tags: [info, network]

    # ========================================================================
    # AMI DISCOVERY PHASE: Find the latest AMI matching criteria
    # ========================================================================
    - name: "Discover latest AMI matching specified criteria"
      amazon.aws.ec2_ami_info:
        region: "{{ aws_region }}"
        owners: "{{ aws_ami_owner | default(['amazon']) }}"
        filters:
          name: "{{ ami_name | default('amzn2-ami-hvm-*-x86_64-gp2') }}"
          state: available
          architecture: x86_64
      register: ami_discovery
      tags: [ami, discovery]

    - name: "Select most recent AMI from discovery results"
      set_fact:
        selected_ami: "{{ ami_discovery.images | sort(attribute='creation_date') | last }}"
      when: ami_discovery.images | length > 0
      tags: [ami, discovery]

    - name: "Fail if no suitable AMI found"
      fail:
        msg: "No AMI found matching criteria: {{ ami_name | default('amzn2-ami-hvm-*-x86_64-gp2') }}"
      when: ami_discovery.images | length == 0
      tags: [ami, discovery]

    - name: "Display selected AMI information"
      debug:
        msg:
          - "Selected AMI: {{ selected_ami.image_id }}"
          - "AMI Name: {{ selected_ami.name }}"
          - "Creation Date: {{ selected_ami.creation_date }}"
          - "Description: {{ selected_ami.description | default('N/A') }}"
      tags: [ami, info]

    # ========================================================================
    # COST ESTIMATION PHASE: Calculate estimated costs
    # ========================================================================
    - name: "Calculate estimated hourly cost (USD)"
      set_fact:
        estimated_hourly_cost: >
          {%- if aws_instance_type.startswith('t2.nano') -%}0.0058
          {%- elif aws_instance_type.startswith('t2.micro') -%}0.0116
          {%- elif aws_instance_type.startswith('t2.small') -%}0.023
          {%- elif aws_instance_type.startswith('t3.nano') -%}0.0052
          {%- elif aws_instance_type.startswith('t3.micro') -%}0.0104
          {%- elif aws_instance_type.startswith('t3.small') -%}0.0208
          {%- elif aws_instance_type.startswith('t3.medium') -%}0.0416
          {%- else -%}0.05
          {%- endif -%}
      tags: [cost, info]

    - name: "Display cost estimation"
      debug:
        msg:
          - "=== Cost Estimation ==="
          - "Instance Type: {{ aws_instance_type }}"
          - "Estimated Hourly Cost: ${{ estimated_hourly_cost }}"
          - "Estimated Daily Cost (24h): ${{ (estimated_hourly_cost | float * 24) | round(2) }}"
          - "Estimated Monthly Cost (30d): ${{ (estimated_hourly_cost | float * 24 * 30) | round(2) }}"
          - "Note: Costs are estimates and may vary by region"
      tags: [cost, info]

    # ========================================================================
    # INSTANCE CREATION PHASE: Deploy EC2 instance with modern module
    # ========================================================================
    - name: "Create EC2 instance with comprehensive configuration"
      amazon.aws.ec2_instance:
        # Basic instance configuration
        name: "{{ project_name | default(app_name) }}-{{ username | default('user') }}-{{ ansible_date_time.epoch }}"
        region: "{{ aws_region }}"
        key_name: "{{ dynamic_key_name }}"
        instance_type: "{{ aws_instance_type }}"
        image_id: "{{ selected_ami.image_id }}"
        
        # Network configuration
        vpc_subnet_id: "{{ final_subnet_id }}"
        security_groups: "{{ [final_security_group] if final_security_group is string else final_security_group }}"
        
        # Storage configuration
        volumes:
          - device_name: /dev/xvda
            ebs:
              volume_type: "{{ root_volume_type | default('gp3') }}"
              volume_size: "{{ root_volume_size | default(8) }}"
              delete_on_termination: true
              encrypted: "{{ encrypt_root_volume | default(true) }}"
        
        # Instance behavior
        instance_initiated_shutdown_behavior: "{{ aws_instance_initiated_shutdown_behavior | default('terminate') }}"
        
        # Comprehensive tagging strategy
        tags:
          Name: "{{ project_name | default(app_name) }}-{{ username | default('user') }}-{{ ansible_date_time.epoch }}"
          Environment: "{{ environment }}"
          Application: "{{ app_name }}"
          Owner: "{{ username | default('automation') }}"
          Project: "{{ project_name | default(app_name) }}"
          CreatedBy: "ansible-ec2-generator"
          CreatedDate: "{{ ansible_date_time.iso8601 }}"
          InstanceType: "{{ aws_instance_type }}"
          CostCenter: "{{ cost_center | default('development') }}"
          AutoShutdown: "{{ auto_shutdown | default('true') }}"
          BackupRequired: "{{ backup_required | default('false') }}"
        
        # Wait for instance to be running
        wait: true
        wait_timeout: 600
        
        # State management
        state: running
        
      register: ec2_result
      tags: [create, instance]

    # ========================================================================
    # POST-CREATION PHASE: Extract and display instance information
    # ========================================================================
    - name: "Extract instance information from creation results"
      set_fact:
        instance_info: "{{ ec2_result.instances[0] }}"
      tags: [info, results]

    - name: "Display comprehensive instance information"
      debug:
        msg:
          - "=== EC2 Instance Successfully Created ==="
          - "Instance ID: {{ instance_info.instance_id }}"
          - "Instance Type: {{ instance_info.instance_type }}"
          - "State: {{ instance_info.state.name }}"
          - "Private IP: {{ instance_info.private_ip_address | default('N/A') }}"
          - "Public IP: {{ instance_info.public_ip_address | default('N/A') }}"
          - "Public DNS: {{ instance_info.public_dns_name | default('N/A') }}"
          - "Availability Zone: {{ instance_info.placement.availability_zone }}"
          - "Launch Time: {{ instance_info.launch_time }}"
          - "AMI ID: {{ instance_info.image_id }}"
          - "Key Name: {{ instance_info.key_name }}"
          - "Security Groups: {{ instance_info.security_groups | map(attribute='group_name') | list | join(', ') }}"
          - "Subnet ID: {{ instance_info.subnet_id }}"
          - "VPC ID: {{ instance_info.vpc_id }}"
      tags: [info, results, always]

    # ========================================================================
    # CONNECTION TESTING PHASE: Verify instance accessibility
    # ========================================================================
    - name: "Wait for SSH to become available (if public IP exists)"
      wait_for:
        host: "{{ instance_info.public_ip_address }}"
        port: 22
        delay: 30
        timeout: 120
        state: started
      when: 
        - instance_info.public_ip_address is defined
        - instance_info.public_ip_address != ""
        - test_ssh_connectivity | default(false) | bool
      ignore_errors: true
      tags: [connectivity, test]

    - name: "Generate SSH connection command"
      debug:
        msg:
          - "=== SSH Connection Information ==="
          - "SSH Command: ssh -i ./{{ dynamic_key_name }}.pem ec2-user@{{ instance_info.public_ip_address | default(instance_info.private_ip_address) }}"
          - "Note: Ensure your SSH key has proper permissions (chmod 400)"
      when: instance_info.public_ip_address is defined or instance_info.private_ip_address is defined
      tags: [connectivity, info]

    # ========================================================================
    # CLEANUP REMINDER PHASE: Display termination information
    # ========================================================================
    - name: "Display cleanup and cost management information"
      debug:
        msg:
          - "=== Important Reminders ==="
          - "üí∞ This instance will incur costs of approximately ${{ estimated_hourly_cost }}/hour"
          - "üïí Remember to terminate the instance when no longer needed"
          - "üîß Termination command: aws ec2 terminate-instances --instance-ids {{ instance_info.instance_id }}"
          - "üîë Key pair cleanup: aws ec2 delete-key-pair --key-name {{ dynamic_key_name }} --region {{ aws_region }}"
          - "üìÅ Local key file: rm ./{{ dynamic_key_name }}.pem"
          - "üìä Monitor costs via AWS Cost Explorer"
          - "‚ö° Consider using auto-shutdown tags for cost optimization"
          - "üîí Ensure security groups follow least privilege principle"
          - "üåê For SSH access, add port 22 rule to security group: aws ec2 authorize-security-group-ingress --group-id {{ final_security_group }} --protocol tcp --port 22 --cidr 0.0.0.0/0 --region {{ aws_region }}"
          - "‚ö†Ô∏è  Warning: Opening SSH to 0.0.0.0/0 is a security risk - use your specific IP instead"
      tags: [info, cleanup, always]

    # ========================================================================
    # OPTIONAL KEY CLEANUP PHASE: Remove key pair if requested
    # ========================================================================
    - name: "Clean up EC2 key pair (optional)"
      amazon.aws.ec2_key:
        name: "{{ dynamic_key_name }}"
        region: "{{ aws_region }}"
        state: absent
      when: cleanup_keypair | default(false) | bool
      tags: [cleanup, keypair]

    - name: "Remove local private key file (optional)"
      file:
        path: "./{{ dynamic_key_name }}.pem"
        state: absent
      when: cleanup_keypair | default(false) | bool
      tags: [cleanup, keypair]
