---
# ============================================================================
# Ansible EC2 Instance Cleanup Playbook
# ============================================================================
# Purpose: Clean up EC2 instances and associated resources to avoid costs
# Author: Infrastructure Automation Team
# Version: 1.0
# Last Updated: $(date +%Y-%m-%d)
# ============================================================================

- name: "Cleanup EC2 Resources"
  hosts: localhost
  connection: local
  gather_facts: true
  
  # Load configuration variables from external file
  vars_files:
    - vars/vars.yml

  tasks:
    # ========================================================================
    # DISCOVERY PHASE: Find instances to terminate
    # ========================================================================
    - name: "Find EC2 instances created by ansible-ec2-generator using AWS CLI"
      command: >
        aws ec2 describe-instances 
        --region {{ aws_region }} 
        --filters 
        "Name=tag:CreatedBy,Values=ansible-ec2-generator" 
        "Name=tag:Application,Values={{ app_name }}" 
        "Name=tag:Environment,Values={{ environment }}" 
        "Name=instance-state-name,Values=running,stopped,stopping" 
        --query "Reservations[].Instances[].[InstanceId,Tags[?Key=='Name'].Value|[0],State.Name,LaunchTime]" 
        --output text
      register: instances_query_result
      tags: [discovery, cleanup]

    - name: "Parse instance discovery results"
      set_fact:
        instances_to_cleanup: 
          instances: |
            {% set instances = [] %}
            {% if instances_query_result.stdout.strip() != "" %}
              {% for line in instances_query_result.stdout.strip().split('\n') %}
                {% set parts = line.split('\t') %}
                {% if parts|length >= 4 %}
                  {% set instance = {
                    'instance_id': parts[0],
                    'name': parts[1] if parts[1] != 'None' else 'N/A',
                    'state': {'name': parts[2]},
                    'launch_time': parts[3]
                  } %}
                  {% set _ = instances.append(instance) %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {{ instances }}
      tags: [discovery, cleanup]

    - name: "Display found instances for cleanup"
      debug:
        msg:
          - "=== Found {{ instances_to_cleanup.instances | length }} instances to cleanup ==="
          - "{% for instance in instances_to_cleanup.instances %}"
          - "Instance ID: {{ instance.instance_id }}"
          - "Name: {{ instance.name }}"
          - "State: {{ instance.state.name }}"
          - "Launch Time: {{ instance.launch_time }}"
          - "---"
          - "{% endfor %}"
      when: instances_to_cleanup.instances | length > 0
      tags: [discovery, info]

    - name: "No instances found for cleanup"
      debug:
        msg: "No instances found matching the cleanup criteria"
      when: instances_to_cleanup.instances | length == 0
      tags: [discovery, info]

    # ========================================================================
    # TERMINATION PHASE: Terminate found instances
    # ========================================================================
    - name: "Terminate EC2 instances using AWS CLI"
      command: aws ec2 terminate-instances --region {{ aws_region }} --instance-ids {{ instances_to_cleanup.instances | map(attribute='instance_id') | join(' ') }}
      when: 
        - instances_to_cleanup.instances | length > 0
        - confirm_termination | default (false) | bool
      register: termination_result
      tags: [termination, cleanup]

    - name: "Parse termination results"
      set_fact:
        termination_parsed:
          instances: "{{ instances_to_cleanup.instances }}"
      when: 
        - termination_result is defined
        - termination_result.rc == 0
      tags: [termination, cleanup]

    - name: "Display termination results"
      debug:
        msg:
          - "=== Instance Termination Results ==="
          - "Terminated {{ instances_to_cleanup.instances | length }} instances"
          - "{% for instance in instances_to_cleanup.instances %}"
          - "Instance ID: {{ instance.instance_id }} - State: terminating"
          - "{% endfor %}"
      when: 
        - termination_result is defined
        - termination_result.rc == 0
      tags: [termination, info]

    # ========================================================================
    # KEY PAIR CLEANUP PHASE: Remove generated key pairs
    # ========================================================================
    - name: "Find key pairs created by ansible-ec2-generator"
      command: aws ec2 describe-key-pairs --region {{ aws_region }} --query "KeyPairs[?starts_with(KeyName, '{{ app_name }}-{{ environment }}-')].KeyName" --output text
      register: keypairs_to_cleanup
      tags: [keypair, discovery]

    - name: "Display found key pairs for cleanup"
      debug:
        msg:
          - "=== Found key pairs to cleanup ==="
          - "{{ keypairs_to_cleanup.stdout.split() }}"
      when: keypairs_to_cleanup.stdout != ""
      tags: [keypair, info]

    - name: "Delete found key pairs"
      amazon.aws.ec2_key:
        name: "{{ item }}"
        region: "{{ aws_region }}"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      tags: [keypair, cleanup]

    - name: "Remove local key files"
      file:
        path: "./{{ item }}.pem"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      ignore_errors: true
      tags: [keypair, cleanup]

    # ========================================================================
    # SUMMARY PHASE: Display cleanup summary
    # ========================================================================
    - name: "Display cleanup summary"
      debug:
        msg:
          - "=== Cleanup Summary ==="
          - "Instances found: {{ instances_to_cleanup.instances | length }}"
          - "Instances terminated: {{ instances_to_cleanup.instances | length if (termination_result is defined and termination_result.rc == 0) else 0 }}"
          - "Key pairs cleaned: {{ keypairs_to_cleanup.stdout.split() | length if keypairs_to_cleanup.stdout != '' else 0 }}"
          - "Cleanup completed successfully!"
      tags: [summary, always]

    # ========================================================================
    # WARNING PHASE: Display important notes
    # ========================================================================
    - name: "Display cleanup warnings and notes"
      debug:
        msg:
          - "=== Important Notes ==="
          - "âš ï¸  Instance termination is irreversible!"
          - "ðŸ’¾ Ensure you have backed up any important data"
          - "ðŸ” Verify in AWS Console that resources were properly cleaned up"
          - "ðŸ’° This should stop ongoing costs for these resources"
          - "ðŸ“Š Monitor AWS Cost Explorer to confirm cost reduction"
      when: 
        - termination_result is defined
        - termination_result.rc == 0
        - instances_to_cleanup.instances | length > 0
      tags: [warning, always]
