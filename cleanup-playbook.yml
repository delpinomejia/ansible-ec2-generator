---
# ============================================================================
# Ansible EC2 Instance Cleanup Playbook
# ============================================================================
# Purpose: Clean up EC2 instances and associated resources to avoid costs
# Author: Infrastructure Automation Team
# Version: 1.0
# Last Updated: $(date +%Y-%m-%d)
# ============================================================================

- name: "Cleanup EC2 Resources"
  hosts: localhost
  connection: local
  gather_facts: true
  
  # Load configuration variables from external file
  vars_files:
    - vars/vars.yml

  tasks:
    # ========================================================================
    # DEBUG PHASE: Display loaded variables
    # ========================================================================
    - name: "Display loaded variables for debugging"
      debug:
        msg:
          - "AWS Region: {{ aws_region }}"
          - "Application Name: {{ app_name }}"
          - "Environment: {{ environment }}"
      tags: [debug, always]

    # ========================================================================
    # DISCOVERY PHASE: Find instances to terminate
    # ========================================================================
    - name: "Find EC2 instances created by ansible-ec2-generator (CreatedBy tag only)"
      command: >
        aws ec2 describe-instances 
        --region {{ aws_region }} 
        --filters 
        "Name=tag:CreatedBy,Values=ansible-ec2-generator" 
        "Name=instance-state-name,Values=running,stopped,stopping" 
        --query "Reservations[].Instances[].[InstanceId,Tags[?Key=='Name'].Value|[0],State.Name,LaunchTime]" 
        --output text
      register: instances_query_result
      tags: [discovery, cleanup]

    - name: "Display raw AWS query result for debugging"
      debug:
        msg:
          - "Raw AWS CLI output: '{{ instances_query_result.stdout }}'"
          - "Command executed: aws ec2 describe-instances --region {{ aws_region }} --filters Name=tag:CreatedBy,Values=ansible-ec2-generator Name=tag:Application,Values={{ app_name }} Name=tag:Environment,Values={{ environment }} Name=instance-state-name,Values=running,stopped,stopping"
      tags: [debug, always]

    - name: "Check if instances were found"
      set_fact:
        instances_found: "{{ instances_query_result.stdout.strip() != '' }}"
        instance_count: "{{ instances_query_result.stdout.strip().split('\n') | length if instances_query_result.stdout.strip() != '' else 0 }}"
      tags: [discovery, cleanup]

    - name: "Extract instance IDs for termination"
      set_fact:
        instance_ids_to_terminate: "{{ instances_query_result.stdout.strip().split('\n') | map('regex_replace', '^([^\t]+).*', '\\1') | list }}"
      when: instances_found | bool
      tags: [discovery, cleanup]

    - name: "Display found instances for cleanup"
      debug:
        msg: |
          === Found {{ instance_count }} instances to cleanup ===
          Raw output:
          {{ instances_query_result.stdout }}
      when: instances_found | bool
      tags: [discovery, info]

    - name: "No instances found for cleanup"
      debug:
        msg: "No instances found matching the cleanup criteria"
      when: not (instances_found | bool)
      tags: [discovery, info]

    # ========================================================================
    # TERMINATION PHASE: Terminate found instances
    # ========================================================================
    - name: "Terminate EC2 instances using AWS CLI"
      command: aws ec2 terminate-instances --region {{ aws_region }} --instance-ids {{ instance_ids_to_terminate | join(' ') }}
      when: 
        - instances_found | bool
        - confirm_termination | default (false) | bool
      register: termination_result
      tags: [termination, cleanup]

    - name: "Display termination results"
      debug:
        msg: |
          === Instance Termination Results ===
          Terminated {{ instance_count }} instances
          Instance IDs: {{ instance_ids_to_terminate | join(', ') }}
      when: 
        - termination_result is defined
        - termination_result is succeeded
      tags: [termination, info]

    # ========================================================================
    # KEY PAIR CLEANUP PHASE: Remove generated key pairs
    # ========================================================================
    - name: "Find key pairs created by ansible-ec2-generator"
      command: aws ec2 describe-key-pairs --region {{ aws_region }} --query "KeyPairs[?starts_with(KeyName, '{{ app_name }}-{{ environment }}-')].KeyName" --output text
      register: keypairs_to_cleanup
      tags: [keypair, discovery]

    - name: "Display found key pairs for cleanup"
      debug:
        msg:
          - "=== Found key pairs to cleanup ==="
          - "{{ keypairs_to_cleanup.stdout.split() }}"
      when: keypairs_to_cleanup.stdout != ""
      tags: [keypair, info]

    - name: "Delete found key pairs"
      amazon.aws.ec2_key:
        name: "{{ item }}"
        region: "{{ aws_region }}"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      tags: [keypair, cleanup]

    - name: "Remove local key files"
      file:
        path: "./{{ item }}.pem"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      ignore_errors: true
      tags: [keypair, cleanup]

    # ========================================================================
    # SUMMARY PHASE: Display cleanup summary
    # ========================================================================
    - name: "Display cleanup summary"
      debug:
        msg:
          - "=== Cleanup Summary ==="
          - "Instances found: {{ instance_count }}"
          - "Instances terminated: {{ instance_count if (termination_result is defined and termination_result is succeeded) else 0 }}"
          - "Key pairs cleaned: {{ keypairs_to_cleanup.stdout.split() | length if keypairs_to_cleanup.stdout != '' else 0 }}"
          - "Cleanup completed successfully!"
      tags: [summary, always]

    # ========================================================================
    # WARNING PHASE: Display important notes
    # ========================================================================
    - name: "Display cleanup warnings and notes"
      debug:
        msg:
          - "=== Important Notes ==="
          - "‚ö†Ô∏è  Instance termination is irreversible!"
          - "üíæ Ensure you have backed up any important data"
          - "üîç Verify in AWS Console that resources were properly cleaned up"
          - "üí∞ This should stop ongoing costs for these resources"
          - "üìä Monitor AWS Cost Explorer to confirm cost reduction"
      when: 
        - termination_result is defined
        - termination_result is succeeded
        - instances_found | bool
      tags: [warning, always]
