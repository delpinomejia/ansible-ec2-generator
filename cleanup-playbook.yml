---
# ============================================================================
# Ansible EC2 Instance Cleanup Playbook
# ============================================================================
# Purpose: Clean up EC2 instances and associated resources to avoid costs
# Author: Infrastructure Automation Team
# Version: 1.0
# Last Updated: $(date +%Y-%m-%d)
# ============================================================================

- name: "Cleanup EC2 Resources"
  hosts: localhost
  connection: local
  gather_facts: true
  
  # Load configuration variables from external file
  vars_files:
    - vars/vars.yml

  tasks:
    # ========================================================================
    # DISCOVERY PHASE: Find instances to terminate
    # ========================================================================
    - name: "Find EC2 instances created by ansible-ec2-generator"
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          tag:CreatedBy: "ansible-ec2-generator"
          tag:Application: "{{ app_name }}"
          tag:Environment: "{{ environment }}"
          instance-state-name: ["running", "stopped", "stopping"]
      register: instances_to_cleanup
      tags: [discovery, cleanup]

    - name: "Display found instances for cleanup"
      debug:
        msg:
          - "=== Found {{ instances_to_cleanup.instances | length }} instances to cleanup ==="
          - "{% for instance in instances_to_cleanup.instances %}"
          - "Instance ID: {{ instance.instance_id }}"
          - "Name: {{ instance.tags.Name | default('N/A') }}"
          - "State: {{ instance.state.name }}"
          - "Launch Time: {{ instance.launch_time }}"
          - "---"
          - "{% endfor %}"
      when: instances_to_cleanup.instances | length > 0
      tags: [discovery, info]

    - name: "No instances found for cleanup"
      debug:
        msg: "No instances found matching the cleanup criteria"
      when: instances_to_cleanup.instances | length == 0
      tags: [discovery, info]

    # ========================================================================
    # TERMINATION PHASE: Terminate found instances
    # ========================================================================
    - name: "Terminate EC2 instances"
      amazon.aws.ec2_instance:
        instance_ids: "{{ instances_to_cleanup.instances | map(attribute='instance_id') | list }}"
        region: "{{ aws_region }}"
        state: terminated
        wait: true
        wait_timeout: 300
      when: 
        - instances_to_cleanup.instances | length > 0
        - confirm_termination | default (false) | bool
      register: termination_result
      tags: [termination, cleanup]

    - name: "Display termination results"
      debug:
        msg:
          - "=== Instance Termination Results ==="
          - "Terminated {{ termination_result.instances | length }} instances"
          - "{% for instance in termination_result.instances %}"
          - "Instance ID: {{ instance.instance_id }} - State: {{ instance.state.name }}"
          - "{% endfor %}"
      when: 
        - termination_result is defined
        - termination_result.instances is defined
      tags: [termination, info]

    # ========================================================================
    # KEY PAIR CLEANUP PHASE: Remove generated key pairs
    # ========================================================================
    - name: "Find key pairs created by ansible-ec2-generator"
      command: aws ec2 describe-key-pairs --region {{ aws_region }} --query "KeyPairs[?starts_with(KeyName, '{{ app_name }}-{{ environment }}-')].KeyName" --output text
      register: keypairs_to_cleanup
      tags: [keypair, discovery]

    - name: "Display found key pairs for cleanup"
      debug:
        msg:
          - "=== Found key pairs to cleanup ==="
          - "{{ keypairs_to_cleanup.stdout.split() }}"
      when: keypairs_to_cleanup.stdout != ""
      tags: [keypair, info]

    - name: "Delete found key pairs"
      amazon.aws.ec2_key:
        name: "{{ item }}"
        region: "{{ aws_region }}"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      tags: [keypair, cleanup]

    - name: "Remove local key files"
      file:
        path: "./{{ item }}.pem"
        state: absent
      loop: "{{ keypairs_to_cleanup.stdout.split() }}"
      when: 
        - keypairs_to_cleanup.stdout != ""
        - cleanup_keypairs | default(true) | bool
      ignore_errors: true
      tags: [keypair, cleanup]

    # ========================================================================
    # SUMMARY PHASE: Display cleanup summary
    # ========================================================================
    - name: "Display cleanup summary"
      debug:
        msg:
          - "=== Cleanup Summary ==="
          - "Instances found: {{ instances_to_cleanup.instances | length }}"
          - "Instances terminated: {{ termination_result.instances | length if termination_result is defined else 0 }}"
          - "Key pairs cleaned: {{ keypairs_to_cleanup.stdout.split() | length if keypairs_to_cleanup.stdout != '' else 0 }}"
          - "Cleanup completed successfully!"
      tags: [summary, always]

    # ========================================================================
    # WARNING PHASE: Display important notes
    # ========================================================================
    - name: "Display cleanup warnings and notes"
      debug:
        msg:
          - "=== Important Notes ==="
          - "âš ï¸  Instance termination is irreversible!"
          - "ðŸ’¾ Ensure you have backed up any important data"
          - "ðŸ” Verify in AWS Console that resources were properly cleaned up"
          - "ðŸ’° This should stop ongoing costs for these resources"
          - "ðŸ“Š Monitor AWS Cost Explorer to confirm cost reduction"
      when: termination_result is defined and termination_result.instances | length > 0
      tags: [warning, always]
