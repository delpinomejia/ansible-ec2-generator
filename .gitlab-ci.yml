# ============================================================================
# GitLab CI/CD Pipeline for Ansible EC2 Instance Generator
# ============================================================================
# Focused pipeline for Ansible playbook validation and Packer-based deployment
# ============================================================================

# Define pipeline execution stages
stages:
  - validate
  - build
  - deploy

# Global variables
variables:
  ANSIBLE_HOST_KEY_CHECKING: "false"
  ANSIBLE_FORCE_COLOR: "true"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# Cache pip dependencies for faster builds
cache:
  paths:
    - .pip-cache/
    - venv/

# ============================================================================
# VALIDATION STAGE: Comprehensive syntax and structure validation
# ============================================================================

validate_all:
  stage: validate
  before_script:
    # Use system-installed Ansible on Debian runner
    - ansible --version
    - ansible-galaxy collection install amazon.aws community.general --force
  script:
    - echo "üîç Validating Ansible playbook syntax..."
    - ansible-playbook --syntax-check ec2-playbook.yml
    - echo "‚úÖ Ansible syntax validation passed"
    - echo "üîç Validating YAML file structure..."
    - yamllint -d relaxed *.yml vars/*.yml || echo "‚ö†Ô∏è  YAML warnings found (non-blocking)"
    - echo "‚úÖ YAML validation completed"
    - echo "üîç Running Ansible Lint checks..."
    - ansible-lint ec2-playbook.yml || echo "‚ö†Ô∏è  Lint warnings found (non-blocking)"
    - echo "‚úÖ Ansible lint completed"
    - echo "üîç Checking for hardcoded secrets..."
    - grep -r "aws_access_key\|aws_secret_key\|password" . --include="*.yml" --exclude="*sample*" || echo "‚úÖ No hardcoded credentials found"
    - echo "‚úÖ Security check completed"
    - echo "üéâ All validation checks completed successfully!"
  allow_failure: false
  tags:
    - homelab
    - local

# ============================================================================
# BUILD STAGE: Prepare AMI artifacts with Packer
# ============================================================================

build_ami:
  stage: build
  script:
    - echo "üî® Starting AMI build process"
    - echo "üìã Build Information:"
    - echo "   - Ansible playbooks: Validated ‚úÖ"
    - echo "   - Target: AWS EC2 AMI"
    - echo "   - Provisioner: Packer with ansible-local"
    - echo "   - Build trigger: Manual deployment required"
    - echo ""
    - echo "üöÄ To build AMI, run:"
    - echo "   packer build -var-file=variables.json packer-template.json"
    - echo ""
    - echo "üìù Note: Ansible provisioning happens inside EC2 during AMI build"
    - echo "‚úÖ Build stage completed - Ready for deployment"
  when: manual
  only:
    - main
    - master
  tags:
    - homelab
    - local

# ============================================================================
# DEPLOYMENT STAGE: Deploy EC2 instances using validated playbooks
# ============================================================================

deploy_infrastructure:
  stage: deploy
  script:
    - echo "üöÄ Starting EC2 infrastructure deployment"
    - echo "üìã Deployment Information:"
    - echo "   - Validation: Passed ‚úÖ"
    - echo "   - Configuration: Ready ‚úÖ"
    - echo "   - Target: AWS EC2 Infrastructure"
    - echo ""
    - echo "üìù Deployment Commands:"
    - echo "   1. Run: ansible-playbook ec2-playbook.yml"
    - echo "   2. Or use: packer build (for AMI creation)"
    - echo ""
    - echo "‚ö†Ô∏è  Important Notes:"
    - echo "   - Ensure AWS credentials are configured"
    - echo "   - Review vars/vars.yml for your environment"
    - echo "   - Monitor AWS costs during deployment"
    - echo ""
    - echo "‚úÖ Deployment information provided - Manual execution required"
  environment:
    name: production
  when: manual
  only:
    - main
    - master
  tags:
    - homelab
    - local
