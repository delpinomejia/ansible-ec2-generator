stages:
  - validate
  - build
  - deploy
  - cleanup

validate_all:
  stage: validate
  script:
    - ansible --version
    - ansible-playbook --syntax-check ec2-playbook.yml
    - ansible-playbook --syntax-check cleanup-playbook.yml
    - echo "Validation completed"
  tags:
    - homelab
    - local

build_configuration:
  stage: build
  script:
    - echo "Build stage"
    - ls -la vars/
    - cp vars/vars_sample.yml vars/vars.yml
    - echo "Configuration prepared"
  artifacts:
    paths:
      - vars/vars.yml
    expire_in: 1 hour
  tags:
    - homelab
    - local

deploy_to_aws:
  stage: deploy
  script:
    - echo "Deploy stage"
    - ansible-playbook ec2-playbook.yml
  tags:
    - homelab
    - local

cleanup_aws:
  stage: cleanup
  script:
    - echo "Cleanup stage - Terminating EC2 instances"
    - ansible-playbook cleanup-playbook.yml -e "confirm_termination=true"
  when: manual
  allow_failure: true
  tags:
    - homelab
    - local
