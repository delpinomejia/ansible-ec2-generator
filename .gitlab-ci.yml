stages:
  - validate
  - build
  - deploy

variables:
  ANSIBLE_HOST_KEY_CHECKING: "false"

validate_all:
  stage: validate
  script:
    - ansible --version
    - ansible-galaxy collection install amazon.aws community.general --force
    - ansible-playbook --syntax-check ec2-playbook.yml
    - echo "Validation completed successfully"
  tags:
    - homelab
    - local

build_configuration:
  stage: build
  script:
    - echo "Preparing AWS deployment configuration..."
    - cp vars/vars_sample.yml vars/vars.yml || echo "vars.yml already exists"
    - echo "Configuration prepared for deployment"
  tags:
    - homelab
    - local

deploy_to_aws:
  stage: deploy
  script:
    - echo "Checking AWS credentials and configuration..."
    - aws sts get-caller-identity || echo "Warning: AWS credentials not configured"
    - test -f vars/vars.yml || echo "Warning: vars.yml not found"
    - echo "Starting AWS EC2 deployment..."
    - echo "Running deployment dry-run first..."
    - ansible-playbook ec2-playbook.yml --check --diff
    - echo "Dry run completed successfully"
    - echo "Deploying infrastructure with Ansible..."
    - ansible-playbook ec2-playbook.yml
    - echo "AWS deployment completed successfully"
  environment:
    name: production
  tags:
    - homelab
    - local
