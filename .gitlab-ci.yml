# ============================================================================
# GitLab CI/CD Pipeline for Ansible EC2 Instance Generator
# ============================================================================
# This pipeline validates, tests, and provides deployment capabilities for
# the Ansible EC2 Instance Generator project.
# ============================================================================

# Define pipeline execution stages
stages:
  - validate
  - test
  - security
  - deploy
  - cleanup

# Global variables
variables:
  ANSIBLE_HOST_KEY_CHECKING: "false"
  ANSIBLE_FORCE_COLOR: "true"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# Cache pip dependencies for faster builds
cache:
  paths:
    - .pip-cache/
    - venv/

# ============================================================================
# VALIDATION STAGE: Syntax and structure validation
# ============================================================================

validate_ansible_syntax:
  stage: validate
  image: python:3.9-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git ssh
    - pip install --upgrade pip
    - pip install ansible
    - ansible-galaxy collection install amazon.aws community.general
  script:
    - echo "Validating Ansible playbook syntax..."
    - ansible-playbook --syntax-check ec2-playbook.yml
    - echo "Ansible syntax validation completed successfully"
  tags:
    - homelab
    - local

validate_yaml_files:
  stage: validate
  image: python:3.9-slim
  before_script:
    - pip install yamllint
  script:
    - echo "Validating YAML file structure..."
    - yamllint -d relaxed *.yml vars/*.yml
    - echo "YAML validation completed successfully"
  allow_failure: true
  tags:
    - homelab
    - local

# ============================================================================
# TESTING STAGE: Comprehensive testing and linting
# ============================================================================

test_ansible_lint:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install ansible ansible-lint
    - ansible-galaxy collection install amazon.aws community.general
  script:
    - echo "Running Ansible Lint checks..."
    - ansible-lint ec2-playbook.yml || echo "Lint warnings found (non-blocking)"
    - echo "Ansible lint completed"
  allow_failure: true
  tags:
    - homelab
    - local

test_dry_run:
  stage: test
  image: python:3.9-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git ssh
    - pip install ansible boto3 botocore
    - ansible-galaxy collection install amazon.aws community.general
    - cp vars/vars_sample.yml vars/vars.yml
  script:
    - echo "Running Ansible playbook dry-run (check mode)..."
    - ansible-playbook --check --diff ec2-playbook.yml || echo "Dry run completed with warnings (expected without real AWS credentials)"
    - echo "Dry run testing completed"
  allow_failure: true
  tags:
    - homelab
    - local

# ============================================================================
# SECURITY STAGE: Security scanning and validation
# ============================================================================

security_scan:
  stage: security
  image: python:3.9-slim
  before_script:
    - pip install bandit safety
  script:
    - echo "Running security scans..."
    - echo "Checking for hardcoded secrets in YAML files..."
    - grep -r "aws_access_key\|aws_secret_key\|password" . --include="*.yml" --exclude="*sample*" || echo "No hardcoded credentials found"
    - echo "Security scan completed"
  tags:
    - homelab
    - local

# ============================================================================
# DEPLOYMENT STAGE: Conditional deployment with manual approval
# ============================================================================

deploy_infrastructure:
  stage: deploy
  image: python:3.9-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git ssh awscli
    - pip install ansible boto3 botocore
    - ansible-galaxy collection install amazon.aws community.general
  script:
    - echo "Starting EC2 infrastructure deployment"
    - echo "Configuration check complete"
    - echo "Manual deployment required"
    - echo "Run ansible-playbook ec2-playbook.yml to deploy"
    - echo "Deployment job completed successfully"
  environment:
    name: production
    on_stop: cleanup_resources
  when: manual
  only:
    - main
    - master
  tags:
    - homelab
    - local

# ============================================================================
# CLEANUP STAGE: Resource cleanup and cost management
# ============================================================================

cleanup_resources:
  stage: cleanup
  image: python:3.9-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq awscli
  script:
    - echo "Resource Cleanup Information"
    - echo "To avoid unnecessary AWS charges remember to:"
    - echo "1. Terminate EC2 instances when no longer needed"
    - echo "2. Remove unused EBS volumes"
    - echo "3. Review AWS Cost Explorer regularly"
    - echo "Cleanup commands:"
    - echo "aws ec2 describe-instances --filters Name=tag:CreatedBy,Values=ansible-ec2-generator"
    - echo "aws ec2 terminate-instances --instance-ids instance-id"
    - echo "Cost monitoring resources:"
    - echo "AWS Cost Explorer at console.aws.amazon.com"
    - echo "AWS Budgets at console.aws.amazon.com"
    - echo "Cleanup information provided"
  environment:
    name: production
    action: stop
  when: manual
  tags:
    - homelab
    - local

# ============================================================================
# DOCUMENTATION STAGE: Generate and validate documentation
# ============================================================================

validate_documentation:
  stage: validate
  image: node:16-alpine
  before_script:
    - npm install -g markdownlint-cli
  script:
    - echo "Validating documentation..."
    - markdownlint README.md || echo "Documentation warnings found (non-blocking)"
    - echo "Documentation validation completed"
  allow_failure: true
  tags:
    - homelab
    - local
